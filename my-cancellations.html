<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cancellations - Alina Collection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <!-- Navigation -->
    <section id="header">
        <a href="index.html"><img src="image/Logo/logo.png" class="logo" alt="Alina Collection"/></a>
        <div class="header-search">
            <input type="text" placeholder="Search premium fashion..." id="header-search-input">
            <button type="button" id="header-search-btn"><i class="fas fa-search"></i></button>
        </div>
        <div>
            <ul id="navbar">
                <li><a href="index.html">Home</a></li>
                <li>
                    <a href="shop.html">Shop <i class="fas fa-angle-down"></i></a>
                    <ul class="dropdown-menu">
                        <li><a href="shop.html?cat=Tops">Tops & Shirts</a></li>
                        <li><a href="shop.html?cat=Bottoms">Pants & Bottoms</a></li>
                        <li><a href="shop.html?cat=Dresses">Dresses</a></li>
                        <li><a href="shop.html?cat=Outerwear">Outerwear</a></li>
                        <li><a href="shop.html?cat=Footwear">Footwear</a></li>
                        <li><a href="shop.html?cat=Accessories">Accessories</a></li>
                    </ul>
                </li>
                <li><a href="about.html">Our Story</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </div>
    </section>

    <!-- Back Button -->
    <div class="back-btn-container">
        <a href="user-dashboard.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- My Cancellations Content -->
    <div class="dashboard-container">
        <div class="dash-card">
            <div class="dash-header-modern">
                <h2><i class="fa-solid fa-times-circle"></i> My Cancellations</h2>
                <p>View and manage your cancelled orders and refund status.</p>
            </div>

            <!-- Cancellations Summary Stats -->
            <div class="dashboard-grid-3" style="margin-bottom: 30px;">
                <div class="summary-stat-card">
                    <div class="stat-icon" style="background: #fef2f2; color: #ef4444;">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="total-cancellations-count">0</h3>
                        <p>Total Cancellations</p>
                    </div>
                </div>
                <div class="summary-stat-card">
                    <div class="stat-icon" style="background: #f0fdf4; color: #22c55e;">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="refunded-amount">NPR 0</h3>
                        <p>Total Refunded</p>
                    </div>
                </div>
                <div class="summary-stat-card">
                    <div class="stat-icon" style="background: #fff7ed; color: #f97316;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="pending-refunds-count">0</h3>
                        <p>Pending Refunds</p>
                    </div>
                </div>
            </div>

            <!-- Cancellations List -->
            <div class="cancellations-list" id="cancellations-list">
                <div class="empty-state" style="text-align: center; padding: 60px 20px; color: var(--dash-text-muted);">
                    <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3; color: #22c55e;"></i>
                    <h3>No Cancellations</h3>
                    <p>You haven't cancelled any orders. That's great!</p>
                    <a href="my-orders.html" class="normal" style="margin-top: 20px; display: inline-block;">View My Orders</a>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            renderMyCancellations(user.email);
        });

        function renderMyCancellations(userEmail) {
            const allOrders = JSON.parse(localStorage.getItem('orders')) || [];
            const cancelledOrders = allOrders.filter(o => o.userEmail === userEmail && o.status === 'cancelled');
            const allProducts = JSON.parse(localStorage.getItem('products')) || [];
            
            // Update summary stats
            const totalCancellations = cancelledOrders.length;
            const totalRefunded = cancelledOrders.reduce((sum, order) => sum + order.total, 0);
            const pendingRefunds = cancelledOrders.filter(o => !o.refunded).length;
            
            document.getElementById('total-cancellations-count').textContent = totalCancellations;
            document.getElementById('refunded-amount').textContent = `NPR ${totalRefunded}`;
            document.getElementById('pending-refunds-count').textContent = pendingRefunds;

            const container = document.getElementById('cancellations-list');
            
            if (cancelledOrders.length === 0) {
                return; // Keep empty state
            }

            // Sort cancellations by date (newest first)
            const sortedCancellations = cancelledOrders.sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = sortedCancellations.map(order => {
                const orderProducts = order.items.map(item => {
                    const product = allProducts.find(p => p.id === item.id);
                    return { ...item, ...product };
                });

                const refundStatus = order.refunded ? 'Refunded' : 'Refund Pending';
                const refundClass = order.refunded ? 'status-delivered' : 'status-pending';

                return `
                    <div class="order-card cancellation-card" style="opacity: 0.9; border-left: 4px solid #ef4444;">
                        <div class="order-header">
                            <div class="order-info">
                                <h3>Order #${order.id} <span style="color: #ef4444; font-size: 14px;">(Cancelled)</span></h3>
                                <p>Originally placed on ${order.date}</p>
                                <p style="font-size: 12px; color: var(--dash-text-muted);">Cancelled on ${order.cancelledDate || order.date}</p>
                            </div>
                            <div class="order-status">
                                <span class="status-badge ${refundClass}">${refundStatus}</span>
                                <p class="order-total">NPR ${order.total}</p>
                            </div>
                        </div>
                        <div class="order-products">
                            ${orderProducts.map(product => `
                                <div class="order-product-item" style="opacity: 0.7;">
                                    <img src="${product.image || 'image/product/f1.jpg'}" alt="${product.name}" 
                                         onerror="this.onerror=null;this.src='image/product/f1.jpg';" 
                                         style="filter: grayscale(100%);">
                                    <div class="product-details">
                                        <h4>${product.name}</h4>
                                        <p>Quantity: ${product.quantity} â€¢ NPR ${product.price}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="cancellation-details">
                            <div class="refund-info">
                                <h4>Refund Information</h4>
                                <p><strong>Refund Status:</strong> ${refundStatus}</p>
                                <p><strong>Refund Amount:</strong> NPR ${order.total}</p>
                                ${order.refunded ? 
                                    `<p><strong>Refund Method:</strong> Original Payment Method</p>
                                     <p><strong>Processing Time:</strong> 3-5 business days</p>` :
                                    `<p style="color: #f97316;"><strong>Expected Refund:</strong> 3-5 business days after cancellation</p>`
                                }
                            </div>
                        </div>
                        <div class="order-actions">
                            <button class="btn-primary" onclick="reorderCancelledItems(${order.id})">
                                <i class="fas fa-redo"></i> Reorder Items
                            </button>
                            ${!order.refunded ? 
                                `<button class="btn-secondary" onclick="checkRefundStatus(${order.id})">
                                    <i class="fas fa-info-circle"></i> Check Refund Status
                                </button>` : ''
                            }
                            <button class="btn-secondary" onclick="downloadCancellationReceipt(${order.id})">
                                <i class="fas fa-download"></i> Download Receipt
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function reorderCancelledItems(orderId) {
            const allOrders = JSON.parse(localStorage.getItem('orders')) || [];
            const order = allOrders.find(o => o.id === orderId);
            
            if (order) {
                // Add all items from this cancelled order to cart
                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                
                order.items.forEach(item => {
                    const existingItem = cart.find(cartItem => cartItem.id === item.id);
                    if (existingItem) {
                        existingItem.quantity += item.quantity;
                    } else {
                        cart.push({ ...item });
                    }
                });
                
                localStorage.setItem('cart', JSON.stringify(cart));
                showToast('Items added to cart successfully!');
                
                // Redirect to cart
                setTimeout(() => {
                    window.location.href = 'cart.html';
                }, 1500);
            }
        }

        function checkRefundStatus(orderId) {
            showToast('Refund is being processed. You will receive an email confirmation once completed.');
        }

        function downloadCancellationReceipt(orderId) {
            showToast('Cancellation receipt download feature coming soon!');
        }
    </script>
</body>
</html>